#include "include/os/ipc.hpp"
#include "include/os/string.hpp"
#include "include/os/syscalls.hpp"

// Full 8x8 Monochrome Font (subset for compactness, but usable)
static uint8_t font8x8[128][8];

void init_font8x8() {
  for (int i = 0; i < 128; i++)
    for (int j = 0; j < 8; j++)
      font8x8[i][j] = 0;

  auto set_char = [](int c, uint8_t d0, uint8_t d1, uint8_t d2, uint8_t d3,
                     uint8_t d4, uint8_t d5, uint8_t d6, uint8_t d7) {
    font8x8[c][0] = d0;
    font8x8[c][1] = d1;
    font8x8[c][2] = d2;
    font8x8[c][3] = d3;
    font8x8[c][4] = d4;
    font8x8[c][5] = d5;
    font8x8[c][6] = d6;
    font8x8[c][7] = d7;
  };

  set_char(33, 0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00);  // !
  set_char(35, 0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00);  // #
  set_char(36, 0x1C, 0x3E, 0x61, 0x3C, 0x07, 0x7E, 0x38, 0x00);  // $
  set_char(43, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00, 0x00);  // +
  set_char(45, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00);  // -
  set_char(46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00);  // .
  set_char(47, 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00);  // /
  set_char(48, 0x3C, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C, 0x00);  // 0
  set_char(49, 0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00);  // 1
  set_char(50, 0x3C, 0x66, 0x06, 0x0C, 0x18, 0x30, 0x7E, 0x00);  // 2
  set_char(51, 0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00);  // 3
  set_char(52, 0x0C, 0x1C, 0x3C, 0x6C, 0x7E, 0x0C, 0x0C, 0x00);  // 4
  set_char(53, 0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00);  // 5
  set_char(54, 0x1C, 0x30, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00);  // 6
  set_char(55, 0x7E, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00);  // 7
  set_char(56, 0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00);  // 8
  set_char(57, 0x3C, 0x66, 0x66, 0x3E, 0x06, 0x0C, 0x38, 0x00);  // 9
  set_char(58, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00);  // :
  set_char(60, 0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x00);  // <
  set_char(62, 0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x00);  // >
  set_char(64, 0x3C, 0x66, 0x06, 0x3E, 0x66, 0x66, 0x3C, 0x00);  // @
  set_char(65, 0x18, 0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x00);  // A
  set_char(66, 0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00);  // B
  set_char(67, 0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00);  // C
  set_char(68, 0x78, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00);  // D
  set_char(69, 0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x7E, 0x00);  // E
  set_char(70, 0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x60, 0x00);  // F
  set_char(71, 0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x3C, 0x00);  // G
  set_char(72, 0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00);  // H
  set_char(73, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00);  // I
  set_char(74, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x6C, 0x38, 0x00);  // J
  set_char(75, 0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x00);  // K
  set_char(76, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00);  // L
  set_char(77, 0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x00);  // M
  set_char(78, 0x66, 0x76, 0x7E, 0x7E, 0x6E, 0x66, 0x66, 0x00);  // N
  set_char(79, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00);  // O
  set_char(80, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00);  // P
  set_char(81, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x0E, 0x00);  // Q
  set_char(82, 0x7C, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0x66, 0x00);  // R
  set_char(83, 0x3C, 0x60, 0x3C, 0x06, 0x06, 0x66, 0x3C, 0x00);  // S
  set_char(84, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00);  // T
  set_char(85, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00);  // U
  set_char(86, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00);  // V
  set_char(87, 0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00);  // W
  set_char(88, 0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00);  // X
  set_char(89, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x00);  // Y
  set_char(90, 0x7E, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x7E, 0x00);  // Z
  set_char(97, 0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x3E, 0x00);  // a
  set_char(98, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x00);  // b
  set_char(99, 0x00, 0x00, 0x3C, 0x60, 0x60, 0x66, 0x3C, 0x00);  // c
  set_char(100, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x3E, 0x00); // d
  set_char(101, 0x00, 0x00, 0x3C, 0x66, 0x7E, 0x60, 0x3C, 0x00); // e
  set_char(102, 0x0E, 0x18, 0x3E, 0x18, 0x18, 0x18, 0x18, 0x00); // f
  set_char(103, 0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x3C); // g
  set_char(104, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00); // h
  set_char(105, 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00); // i
  set_char(106, 0x06, 0x00, 0x06, 0x06, 0x06, 0x66, 0x3C, 0x00); // j
  set_char(107, 0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x00); // k
  set_char(108, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00); // l
  set_char(109, 0x00, 0x00, 0x7E, 0x6B, 0x6B, 0x6B, 0x6B, 0x00); // m
  set_char(110, 0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00); // n
  set_char(111, 0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00); // o
  set_char(112, 0x00, 0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60); // p
  set_char(113, 0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x06); // q
  set_char(114, 0x00, 0x00, 0x7C, 0x66, 0x60, 0x60, 0x60, 0x00); // r
  set_char(115, 0x00, 0x00, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x00); // s
  set_char(116, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x0E, 0x00); // t
  set_char(117, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00); // u
  set_char(118, 0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00); // v
  set_char(119, 0x00, 0x00, 0x63, 0x6B, 0x6B, 0x7F, 0x3E, 0x00); // w
  set_char(120, 0x00, 0x00, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x00); // x
  set_char(121, 0x00, 0x00, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x3C); // y
  set_char(122, 0x00, 0x00, 0x7E, 0x0C, 0x18, 0x30, 0x7E, 0x00); // z
}

class Terminal {
  OS::IPCClient *ipc;
  int master_fd;
  int rows, cols;
  int cursor_x, cursor_y;
  uint32_t bg_color, fg_color;
  uint32_t current_fg;

  void scroll_up() {
    // Basic implementation: clear and reset for now
    // In a real one we'd blit the buffer
    ipc->fill_rect(0, 0, ipc->get_width(), ipc->get_height(), bg_color);
    cursor_x = 0;
    cursor_y = 0;
  }

  void handle_ansi(const char *buf, int *i, int len) {
    if (buf[*i] == '[') {
      (*i)++;
      // Simple color support: \x1b[1;36m
      if (buf[*i] == '1' && buf[*i + 1] == ';' && buf[*i + 2] == '3' &&
          buf[*i + 3] == '6') {
        current_fg = 0xFF00FFFF; // Cyan
        *i += 5;
      } else if (buf[*i] == '0' && buf[*i + 1] == 'm') {
        current_fg = fg_color; // Reset
        *i += 2;
      }
    }
  }

public:
  Terminal()
      : ipc(nullptr), master_fd(-1), rows(25), cols(80), cursor_x(0),
        cursor_y(0), bg_color(0xFF121212), fg_color(0xFFE0E0E0),
        current_fg(0xFFE0E0E0) {}

  void put_char(char c) {
    if (c == '\n') {
      cursor_x = 0;
      cursor_y++;
    } else if (c == '\r') {
      cursor_x = 0;
    } else if (c == '\b') {
      if (cursor_x > 0) {
        cursor_x--;
        ipc->fill_rect(cursor_x * 9, cursor_y * 16, 9, 16, bg_color);
      }
    } else if (c == '\t') {
      cursor_x = (cursor_x + 8) & ~7;
    } else if (c >= 32 && (uint8_t)c < 128) {
      const uint8_t *glyph = font8x8[(uint8_t)c];
      for (int y = 0; y < 8; y++) {
        for (int x = 0; x < 8; x++) {
          if (glyph[y] & (1 << (7 - x))) {
            // Scale to 2x for readability
            ipc->fill_rect(cursor_x * 9 + x, cursor_y * 16 + y * 2, 1, 2,
                           current_fg);
          }
        }
      }
      cursor_x++;
    }

    if (cursor_x >= cols) {
      cursor_x = 0;
      cursor_y++;
    }
    if (cursor_y >= rows) {
      scroll_up();
    }
  }

  void run() {
    ipc = new OS::IPCClient();
    if (!ipc->connect())
      return;
    if (!ipc->create_window("Retro-OS Terminal", 720, 400))
      return;

    ipc->fill_rect(0, 0, 720, 400, bg_color);
    ipc->flush();

    int sfd;
    int res;
    // sys_pty_create is syscall 154
    asm volatile("int $0x80"
                 : "=a"(res)
                 : "a"(154), "b"(&master_fd), "c"(&sfd));

    if (res < 0)
      return;

    // Set Master to Non-Blocking (FIONBIO = 0x5421)
    int nonblock = 1;
    asm volatile("int $0x80"
                 :
                 : "a"(43), "b"(master_fd), "c"(0x5421), "d"(&nonblock));

    int pid = OS::Syscall::fork();
    if (pid == 0) {
      OS::Syscall::close(master_fd);
      OS::Syscall::dup2(sfd, 0);
      OS::Syscall::dup2(sfd, 1);
      OS::Syscall::dup2(sfd, 2);

      const char *path = "/apps/sh.elf";
      char *argv[] = {(char *)path, nullptr};
      OS::Syscall::execve(path, argv, nullptr);
      OS::Syscall::exit(1);
    }

    OS::Syscall::close(sfd);

    char buf[256];
    int frame = 0;

    while (true) {
      // 1. Read from PTY
      int n = OS::Syscall::read(master_fd, buf, sizeof(buf));
      if (n > 0) {
        for (int i = 0; i < n; i++) {
          if (buf[i] == '\x1b') {
            i++;
            handle_ansi(buf, &i, n);
          } else {
            put_char(buf[i]);
          }
        }
        ipc->flush();
      }

      // 2. Events
      OS::gfx_msg_t msg;
      while (ipc->recv_msg(&msg)) {
        if (msg.type == OS::MSG_GFX_KEY_EVENT) {
          char k = msg.data.key.key;
          if (k == 0x08)
            k = '\b';
          if (k == 0x0D)
            k = '\n';
          OS::Syscall::write(master_fd, &k, 1);
        }
      }

      // 3. Cursor Blick
      frame++;
      if (frame % 20 == 0) {
        uint32_t color = (frame % 40 < 20) ? current_fg : bg_color;
        ipc->fill_rect(cursor_x * 9, cursor_y * 16 + 14, 8, 2, color);
        ipc->flush();
      }

      OS::Syscall::sleep(2);
    }
  }
};

extern "C" void _start() {
  init_font8x8();
  Terminal terminal;
  terminal.run();
  OS::Syscall::exit(0);
}
